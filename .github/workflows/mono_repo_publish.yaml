name: Push to Add-Ons Suite
on:
  push:
    paths:
      - node-exporter/**
      - .github/workflows/mono_repo_publish.yaml
    branches: main

  workflow_dispatch:

jobs:
  push-node-exporter:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout source code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Git identity
      run: |
        git config --global user.name "racksync-bot"
        git config --global user.email "devops@racksync.com"

    - name: Validate configuration files
      run: |
        echo "Validating configuration files..."
        cd node-exporter
        python3 -c "import yaml; yaml.safe_load(open('config.yaml'))" || exit 1
        python3 -c "import yaml; yaml.safe_load(open('build.yaml'))" || exit 1
        echo "âœ… All configuration files validated"

    - name: Extract version information
      id: version
      run: |
        VERSION=$(python3 -c "import yaml; print(yaml.safe_load(open('node-exporter/config.yaml'))['version'])")
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "ðŸ“¦ Add-on version: $VERSION"

    - name: Clone mono repository
      run: |
        git clone https://racksync:${{ secrets.API_TOKEN_GITHUB }}@github.com/racksync/hass-addons-suite.git mono-repo
        cd mono-repo
        git config --global user.name "racksync-bot"
        git config --global user.email "devops@racksync.com"

    - name: Check for changes before sync
      id: changes
      run: |
        cd mono-repo
        # Check if node-exporter directory exists
        if [ ! -d "node-exporter" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "ðŸ”„ New node-exporter directory will be created"
        else
          # Backup existing directory
          cp -r node-exporter node-exporter.backup
          echo "ðŸ“‹ Created backup of existing node-exporter directory"
          rm -rf node-exporter
          echo "ðŸ—‘ï¸ Removed existing node-exporter directory"

          # Copy new files
          cp -r ../node-exporter .
          echo "ðŸ“ Copied new node-exporter directory"

          # Check for differences
          if git diff --quiet HEAD -- node-exporter/; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No changes detected"
            # Restore original directory if no changes
            rm -rf node-exporter
            mv node-exporter.backup node-exporter
            echo "â†©ï¸ Restored original directory (no changes)"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "ðŸ”„ Changes detected in node-exporter files"
            rm -rf node-exporter.backup
            echo "ðŸ—‘ï¸ Removed backup (changes detected)"
          fi
        fi

    - name: Sync files to mono repository
      if: steps.changes.outputs.changed == 'true'
      run: |
        echo "ðŸ”„ Syncing files to mono repository..."

        cd mono-repo
        if [ -d "node-exporter.backup" ]; then
          rm -rf node-exporter.backup
        fi

        if [ ! -d "node-exporter" ]; then
          cp -r ../node-exporter .
          echo "ðŸ“ Created new node-exporter directory"
        fi

        echo "âœ… Files synced successfully"

    - name: Commit and push changes
      if: steps.changes.outputs.changed == 'true'
      run: |
        cd mono-repo
        git add node-exporter/
        git commit -m "feat: Prometheus Node Exporter v${{ steps.version.outputs.version }} - Updated from legacy repository"
        git push origin main
        echo "âœ… Changes pushed to mono repository successfully"

    - name: Create release tag
      if: steps.changes.outputs.changed == 'true'
      run: |
        cd mono-repo
        TAG="node-exporter-v${{ steps.version.outputs.version }}"
        if ! git rev-parse "$TAG" >/dev/null 2>&1; then
          git tag -a "$TAG" -m "Prometheus Node Exporter v${{ steps.version.outputs.version }}"
          git push origin "$TAG"
          echo "ðŸ·ï¸ Created tag: $TAG"
        else
          echo "â„¹ï¸ Tag $TAG already exists"
        fi

    
    - name: Summary
      run: |
        echo "## ðŸš€ Prometheus Node Exporter Sync Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "**Changes:** ${{ steps.changes.outputs.changed == 'true' && 'Yes' || 'No' }}" >> $GITHUB_STEP_SUMMARY
        echo "**Source:** [Legacy Repository](https://github.com/racksync/hass-addons-prometheus-node-exporter/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY
        echo "**Target:** [Mono Repository](https://github.com/racksync/hass-addons-suite/tree/main/node-exporter)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.changes.outputs.changed }}" == "true" ]; then
          echo "âœ… Successfully synced to mono repository" >> $GITHUB_STEP_SUMMARY
        else
          echo "â„¹ï¸ No changes to sync" >> $GITHUB_STEP_SUMMARY
        fi